__d(function(g,r,i,_a,m,_e,d){Object.defineProperty(_e,"__esModule",{value:!0}),_e.analyzeQuery=async function(e,t,n){const a=(0,w.asQueryInternals)(t),{customQueryID:s}=a,o=s?{name:s.name,args:s.args}:{ast:e.mapClientASTToServer(a.ast)};return D(await e.getSocket(),{op:"analyze-query",...o,options:n},l.inspectAnalyzeQueryDownSchema)},_e.clientGroupClients=async function(e,t){const n=await t;return T(e,t=>Q(e,t,([e,t])=>t.clientGroupID===n))},_e.clientGroupClientsWithQueries=async function(e,t){const n=await t;return T(e,t=>q(e,t,([e,t])=>t.clientGroupID===n))},_e.clientGroupQueries=function(e){return k(e,{op:"queries"})},_e.clientMap=function(e,t){return T(e,async e=>{const n=await I(e,t),a=new Map;for await(const[e,t]of n.scan(""))a.set(e,t);return a})},_e.clientQueries=function(e,t){return k(e,{op:"queries",clientID:t})},_e.clientRows=function(e,t,n){return T(e,async e=>{const a=y.ENTITIES_KEY_PREFIX+n+"/",s=await I(e,t),o=[];for await(const[e,t]of s.scan(a)){if(!e.startsWith(a))break;o.push(t)}return o})},_e.inspectorClients=function(e){return T(e,t=>Q(e,t))},_e.inspectorClientsWithQueries=function(e){return T(e,t=>q(e,t))},_e.inspectorMetrics=async function(e){const t=e.metrics,n=await D(await e.getSocket(),{op:"metrics"},l.inspectMetricsDownSchema);return E(t,n)},_e.mergeMetrics=E,_e.rpc=D,_e.serverVersion=async function(e){return D(await e.getSocket(),{op:"version"},l.inspectVersionDownSchema)};var e=r(d[0]),t=r(d[1]),n=r(d[2]),a=r(d[3]),s=r(d[4]),o=r(d[5]),c=r(d[6]),u=r(d[7]),p=r(d[8]),l=r(d[9]),w=r(d[10]),f=r(d[11]),y=r(d[12]),h=r(d[13]),v=r(d[14]),S=r(d[15]);async function D(e,t,n){try{return await C(e,t,n)}catch(a){if(a instanceof G){const a=await(0,v.createHTMLPasswordPrompt)("Enter password:");if(a){if(await C(e,{op:"authenticate",value:a},l.inspectAuthenticatedDownSchema))return C(e,t,n)}throw new Error("Authentication failed")}throw a}}function C(e,t,n){return new Promise((a,s)=>{const c=(0,f.nanoid)(),u=t=>{const w=JSON.parse(t.data);if("inspect"===w[0]){const t=w[1];if(t.id!==c)return;const f=(0,p.test)(t,n);if(f.ok)"error"===f.value.op?s(new Error(f.value.value)):a(f.value.value);else{const e=(0,p.test)(t,l.inspectAuthenticatedDownSchema);e.ok&&((0,o.assert)(!1===e.value.value,"Expected unauthenticated response"),s(new G)),s(f.error)}e.removeEventListener("message",u)}};e.addEventListener("message",u),e.send(JSON.stringify(["inspect",{...t,id:c}]))})}function E(e,t){return{...e??{"query-materialization-client":new u.TDigest,"query-materialization-end-to-end":new u.TDigest,"query-update-client":new u.TDigest},...t?(n=t,(0,c.mapValues)(n,e=>u.TDigest.fromJSON(e))):{"query-materialization-server":new u.TDigest,"query-update-server":new u.TDigest}};var n}async function T(e,t){const{rep:n}=e;return await n.refresh(),await n.persist(),(0,s.withRead)(n.perdag,t)}async function I(s,c){const u=await(0,a.getClient)(c,s);(0,o.assert)(u,`Client not found: ${c}`);const{clientGroupID:p}=u,l=await(0,n.getClientGroup)(p,s);(0,o.assert)(l,`Client group not found: ${p}`);return(await(0,e.readFromHash)(l.headHash,s,t.Latest)).map}async function Q(e,t,n=()=>!0){return[...(await(0,a.getClients)(t)).entries()].filter(n).map(([t,{clientGroupID:n}])=>new h.Client(e,t,n))}async function q(e,t,n=()=>!0){const a=await Q(e,t,n),s=[];return await Promise.all(a.map(async e=>{(await e.queries()).length>0&&s.push(e)})),s}async function k(e,t){const n=(await D(await e.getSocket(),t,l.inspectQueriesDownSchema)).map(t=>new S.Query(t,e,e.getSocket));return n.sort((e,t)=>(t.hydrateServer??0)-(e.hydrateServer??0)),n}class G extends Error{}},694,[511,479,517,494,516,459,547,695,487,622,557,636,686,692,697,698]);
__d(function(g,r,i,a,m,_e,d){function e(){try{return("undefined"==typeof globalThis||!("__vitest_worker__"in globalThis))&&("undefined"!=typeof document&&"function"==typeof document.createElement&&"undefined"!=typeof HTMLDialogElement&&null!==document.body&&document.createElement("dialog")instanceof HTMLDialogElement)}catch{return!1}}Object.defineProperty(_e,"__esModule",{value:!0}),_e.createHTMLPasswordPrompt=function(t){if(!e())return Promise.resolve(prompt(t));return new Promise(e=>{const n="all:revert;",o="rgba(255,255,255,0.4)",s="0.25rem",l="font-family:system-ui,sans-serif;color:rgba(255,255,255,1);",c=document.createElement("dialog");c.style.cssText=`${n}${l}background:rgba(0,0,0,0.95);padding:2rem;border:1px solid ${o};border-radius:0.5rem;`,c.addEventListener("keydown",e=>{e.stopPropagation()}),c.oncancel=()=>{c.remove(),e(null)};const u=document.createElement("form");u.method="dialog",u.style.cssText=`${n}margin:0;`;const p=document.createElement("p");p.style.cssText=`${n}${l}font-size:1.5rem;margin:0 0 1rem 0;`,p.append(t);const f=document.createElement("input");f.type="password",f.placeholder="Admin password",f.autocomplete="current-password",f.autofocus=!0,f.style.cssText=`${n}${l}font-size:1rem;display:block;margin:0 0 1rem 0;padding:0.5rem;background:rgba(0,0,0,0.5);border:1px solid ${o};border-radius:${s};`;const b=document.createElement("div");b.style.cssText=n;const y=document.createElement("button");y.type="reset",y.append("Cancel"),y.style.cssText="all:revert;font-family:system-ui,sans-serif;color:rgba(255,255,255,1);cursor:pointer;font-size:1rem;font-weight:500;border:none;padding:0.4rem 0.75rem;border-radius:0.25rem;background:rgba(255,255,255,0.25);";const v=document.createElement("button");v.type="submit",v.value="ok",v.append("OK"),v.style.cssText="all:revert;font-family:system-ui,sans-serif;color:rgba(255,255,255,1);cursor:pointer;font-size:1rem;font-weight:500;border:none;padding:0.4rem 0.75rem;border-radius:0.25rem;background:rgba(19,106,235,1);margin-right:0.5rem;",b.append(v,y),u.append(p,f,b),c.append(u),u.onreset=()=>{c.close()},c.onclose=()=>{"ok"===c.returnValue?e(f.value||null):e(null),c.remove()},document.body.append(c),c.showModal()})}},697,[]);
__d(function(g,r,i,a,m,e,d){Object.defineProperty(e,"__esModule",{value:!0}),e.Query=void 0;var t=r(d[0]),s=r(d[1]),n=r(d[2]),u=r(d[3]),l=r(d[4]);e.Query=class{#e;#t;constructor(s,n,o){this.#e=o;const{ast:h,queryID:c,inactivatedAt:y}=s;this.clientID=s.clientID,this.id=c,this.inactivatedAt=null===y?null:new Date(y),this.ttl=(0,u.normalizeTTL)(s.ttl),this.name=s.name,this.args=s.args,this.got=s.got,this.rowCount=s.rowCount,this.deleted=s.deleted,this.#t=h,this.serverZQL=h?h.table+(0,t.astToZQL)(h):null;const v=n.getAST(c);this.clientZQL=v?v.table+(0,t.astToZQL)(v):null;const p=n.getQueryMetrics(c),q=s.metrics,T=(0,l.mergeMetrics)(p,q);this.metrics=T;const S=(t,s)=>{if(!T?.[t])return null;const n=T[t].quantile(s);return Number.isNaN(n)?null:n};this.hydrateClient=S("query-materialization-client",.5),this.hydrateServer=S("query-materialization-server",.5),this.hydrateTotal=S("query-materialization-end-to-end",.5),this.updateClientP50=S("query-update-client",.5),this.updateClientP95=S("query-update-client",.95),this.updateServerP50=S("query-update-server",.5),this.updateServerP95=S("query-update-server",.95)}async analyze(t){const u=this.name&&this.args?{name:this.name,args:this.args}:{value:(0,s.must)(this.#t,"AST is required for unnamed queries")};return(0,l.rpc)(await this.#e(),{op:"analyze-query",...u,options:t},n.inspectAnalyzeQueryDownSchema)}}},698,[699,536,622,683,694]);
__d(function(g,r,i,a,m,e,d){Object.defineProperty(e,"__esModule",{value:!0}),e.astToZQL=u;var t=r(d[0]),n=r(d[1]),s=r(d[2]);function u(t){let n="";if(t.where&&(n+=o(t.where,".where",new Set)),t.related&&t.related.length>0)for(const s of t.related)if(s.hidden){const t=s.subquery.related?.[0];t&&(n+=h(t))}else n+=h(s);if(t.orderBy&&t.orderBy.length>0&&(n+=q(t.orderBy)),void 0!==t.limit&&(n+=`.limit(${t.limit})`),t.start){const{row:s,exclusive:u}=t.start;n+=`.start(${JSON.stringify(s)}${u?"":", { inclusive: true }"})`}return n}function o(n,s,u){switch(n.type){case"simple":return l(n,s);case"and":case"or":return c(n,s,u);case"correlatedSubquery":return $(n,s,u);default:(0,t.unreachable)()}}function l(t,n){const{left:s,op:u,right:o}=t,l=w(s),c=w(o);return"="===u?`${n}(${l}, ${c})`:`${n}(${l}, '${u}', ${c})`}function c(t,n,s){const{type:u,conditions:l}=t;if(1===l.length)return o(l[0],n,s);if("and"===u){const t=l.map(t=>o(t,n,s));return".where"===n?t.join(""):(s.add("and"),"and("+t.join(", ")+")")}s=new Set;const c=l.map(t=>o(t,"cmp",s)).join(", ");s.add("cmp"),s.add(u);return`.where(({${[...s].sort().join(", ")}}) => ${u}(${c}))`}function $(t,n,s){const{related:o,op:l}=t,c=y(o),$=f(o),h=$.where||$.related&&$.related.length>0||$.orderBy||$.limit;if("EXISTS"===l){const o=t.flip?", {flip: true}":"";return h?".where"===n?`.whereExists('${c}', q => q${u($)}${o})`:(s.add("exists"),`exists('${c}', q => q${u($)}${o})`):".where"===n?`.whereExists('${c}'${o})`:(s.add("exists"),`exists('${c}'${o})`)}return h?".where"===n?`.where(({exists, not}) => not(exists('${c}', q => q${u($)})))`:(s.add("not"),s.add("exists"),`not(exists('${c}', q => q${u($)}))`):".where"===n?`.where(({exists, not}) => not(exists('${c}')))`:(s.add("not"),s.add("exists"),`not(exists('${c}')))`)}function f(t){return"correlatedSubquery"===t.subquery.where?.type&&t.subquery.where.related.subquery.alias?.includes(s.SUBQ_PREFIX+"zhidden_")?f(t.subquery.where.related):t.subquery}function y(t){const u=(0,n.must)(t.subquery.alias);return u.startsWith(s.SUBQ_PREFIX)?u.substring(s.SUBQ_PREFIX.length):u}function h(t){const{alias:n}=t.subquery;if(!n)return"";let s=`.related('${n}'`;return(t.subquery.where||t.subquery.related&&t.subquery.related.length>0||t.subquery.orderBy||t.subquery.limit)&&(s+=", q => q"+u(t.subquery)),s+=")",s}function q(t){let n="";for(const[s,u]of t)n+=`.orderBy('${s}', '${u}')`;return n}function w(n){switch(n.type){case"literal":return b(n);case"column":return`'${n.name}'`;case"static":return p(n);default:(0,t.unreachable)()}}function b(t){return null===t.value?"null":Array.isArray(t.value)?JSON.stringify(t.value):"string"==typeof t.value?`'${t.value.replace(/'/g,"\\'")}'`:String(t.value)}function p(t){return`authParam(${Array.isArray(t.field)?`[${t.field.map(t=>`'${t}'`).join(", ")}]`:`'${t.field}'`})`}},699,[459,536,534]);